<script>
var fancybox_options = {          
                        'overlayShow'   : true,
                        'transitionIn'  : 'elastic',
                        'transitionOut' : 'elastic',
                        'overlayColor'  : '#000',
                        'overlayOpacity': 0.3,
                        'autoScale'     : true,
                        'scrolling'     : 'no'
                        };
$(function () {
      $("#new_item_form form").attr("action", "");
      $("#new_item_form form").attr("method", "");
      $("#new_item_form form").live('submit',
            function () {
                  $.post('/book/new', {
                  "name":$('#name').val(),
                  "price": $('#price').val(),
                  "author": $('#author').val(),
                  "description": $('#description').val()
                  },
            function () {
                  $('#name').val('');
                  $('#price').val('');
                  $('#author').val('');
                  $('#description').val('');
                  updatelistings();
            });
      });
});
function perfectsize () {
      return Math.min($(window).width()-30,$(window).width()*0.95);
}
var Users = [<% @users.each do |user|%>"<%= user.username %>",<% end%>];
$("#messenger").live('submit', function () {
  $.post('/message/create', {"body":$('#body').val(),"recipient": $('#recipient').val(), "sender": $('#sender').val()});
  $('#body').val('');$('#recipient').val('');
});
$(function () {
$("#recipient").autocomplete({
      source: '/user/search',
      position: {
        my: "left bottom",
        at: "left top"
    }
    });
});
function updatelistings () {
      $.get('/listings', function (data){
            $("#book_listings").html(data);
      });
};

// setInterval ("updatelistings()", 5000);

$("a").live('click', function (e) {
      e.preventDefault();
      if ($(this).attr("href")){
            var input = $(this).attr('href').split('/');
            if (input[1] == "book" && input[3]==null){
                  $.post('/book', {id:input[2]}, function (data){
                        $.fancybox(
                              data,
                              fancybox_options);
                  });
            }
            else if (input[1] == "book" && input[3]=="delete") {
                  $.post('/book', {id:input[2], delete : "true"}, function (data){
                        $.fancybox(
                              data,
                              fancybox_options);
                        });
                  }
            else if (input[1] == "user") {
                  $.post('/user', {id:input[2]}, function (data){
                        $.fancybox(
                              data,
                              fancybox_options);
                        });
                  }
            else {
                  location.href=$(this).attr('href');
            }
      }
      
      
});
function removeitem (address) {
      var input = address.split('/');
      if (input[1] == "book" && input[3]==null){
            $.post('/book', {id:input[2]}, function (data){
            $.fancybox(
            data,
            {
                  
                'overlayShow'   : true,
                'transitionIn'  : 'elastic',
                'transitionOut' : 'elastic',
                'overlayColor'  : '#000',
                'overlayOpacity': 0.3,
                'autoScale'     : true,
                'scrolling'     : 'no'
            });
            });
      }
      else if (input[1] == "book" && input[3]=="delete") {
            $.post('/book', {id:input[2], delete : "true"}, function (data){
            $.fancybox(
            data,
            {
                  
                'overlayShow'   : true,
                'transitionIn'  : 'elastic',
                'transitionOut' : 'elastic',
                'overlayColor'  : '#000',
                'overlayOpacity': 0.3,
                'autoScale'     : true,
                'scrolling'     : 'no'
            });
            });
      }
      else if (input[1] == "user" && input[3]=="delete") {
            $.post('/user', {id:input[2], delete : "true"}, function (data){
            $.fancybox(
            data,
            {
                  
                'overlayShow'   : true,
                'transitionIn'  : 'elastic',
                'transitionOut' : 'elastic',
                'overlayColor'  : '#000',
                'overlayOpacity': 0.3,
                'autoScale'     : true,
                'scrolling'     : 'no'
            });
            });
      }
      else {
            location.href=$(this).attr('href');
      }
};

$("#item_edition").live('submit', function (e){
      e.preventDefault();
      console.log($("#item_edition").attr("data-id"));
      console.log($("#sold_editform").attr("checked"));
      console.log($("#description_editform").val());
      $.post('/book/update', {
            "id"  :$("#item_edition").attr("data-id"),
            "name":$('#name_editform').val(),
            "price": $('#price_editform').val(),
            "author": $('#author_editform').val(),
            "sold": $('#sold_editform').attr("checked"),
            "description": $('#description_editform').val()
            },
            function () {
                  $.fancybox.close();
                  updatelistings();
            }
      );
});
</script>




<div class="mainpage_content">
      <table class="book_table" id="new_item_form">
            <form onsubmit="return false;" action="/book/create" method="POST">
                  <tr>
                        <td colspan="2" style="text-align: center" class="book_details">Selling a book?
                        </td>
                  </tr>
                  <tr>
                        <td>
                              <input type="text" name="name" id="name" placeholder="Title" style="width: 90%">
                        </td>
                        <td>
                              <input type="text" name="author" id="author" placeholder="Author" style="width: 90%">
                        </td>
                  </tr>
                        <td colspan="2">
                              <textarea type="text" name="description" id="description" placeholder="description & condition" style="width: 95%; resize: vertical; max-height: 120px
                              "></textarea>
                        </td>
                  </tr>
                  <tr>
                        <td colspan="2">
                              <input type="number" name="price" min="0" max="999" id="price" value="0" style="width: 20%"/>€
                              <input type="submit" value="Sell" style="float: right;"/>
                        </td>
                        
                  </tr>
            </form>
      </table>


<% unless @books.empty? %>
      <table class="book_table" id="book_listings">
            <tr>
                  <td colspan="5" class="table_header">Books:
                  </td>
            </tr>
            <tr>
                  <td>
                  </td>

                  <td class="book_details">Title
                  </td>

                  <td class="book_details">Author
                  </td>

                  <td class="book_details" style="text-align: right">Price
                  </td>

                  <td>
                  </td>
            </tr>

<% @books.each do |book| %>
            <tr>
                  <td class="book_details_sold"><%= "(Sold)" if book.sold %>
                  </td>

                  <td>
                        <a href="/book/<%=book.id%>"><i><%=book.name%></i></a>
                  </td>

                  <td>
                        <a href="/book/<%=book.id%>">by <%= book.author%></a>
                  </td>

                  <td style="color: #444; text-align: right"><%= sprintf("%.2f", book.price) %>€
                  </td>

                  <td class="book_details"><%if book.owner == env['warden'].user.id %>
                        <a href="/book/<%= book.id %>/delete">Remove</a><%else%><%= " added "+relative_time(Time.parse(book.created_at.to_s)) %><%end%>
                  </td>

            </tr>
<% end %>
      </table>
<%else%>
      <p id="book_listings">No books to trade.</p>
<%end%><!-- /Book Listings -->

<h3>Conversations:</h3>

<% unless @messages.empty? %>
      <ul>
<% @messages.each do |m| %>
            <li>
                  <strong><%= User.get(m.sender).username %></strong> : <%= m.body %>
            </li>
<% end %>
      </ul>
<% end %>



</div><!-- /Conversations -->



